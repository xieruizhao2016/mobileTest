# mobileTest - iOS预订数据管理应用

## 📋 项目需求分析

### 业务背景
开发一个iOS移动应用，用于管理和显示船舶预订数据。应用需要从本地JSON文件获取预订信息，并通过分层架构提供数据管理服务。

### 核心功能需求

#### 1. 数据管理器实现
- **目标**：创建数据管理器作为预订数据的提供者，参考 `booking.json` 文件
- **详细要求**：
  - **服务层 (Service Layer)**：
    - 从JSON文件读取预订数据
    - 解析JSON数据为Swift对象
    - 模拟网络请求延迟（可选）
    - 提供数据获取的统一接口
  - **本地持久化缓存层 (Local Persistent Caching Layer)**：
    - 使用UserDefaults存储缓存数据
    - 设置缓存有效期（建议5分钟）
    - 支持缓存数据的读取、保存和清除
    - 缓存失效时自动重新获取数据
  - **数据时效性处理 (Data Timeliness)**：
    - 检查数据中的过期时间戳
    - 判断缓存数据是否仍然有效
    - 处理过期数据的刷新逻辑
  - **刷新机制和统一外部接口**：
    - 提供强制刷新功能
    - 统一的数据获取接口
    - 支持缓存优先策略
    - 新数据与缓存数据的无缝切换
  - **错误处理机制**：
    - 文件读取错误处理
    - JSON解析错误处理
    - 网络请求错误处理（模拟）
    - 缓存操作错误处理
    - 用户友好的错误提示

#### 2. 列表显示页面
- **目标**：创建列表格式的数据展示页面
- **详细要求**：
  - **页面生命周期管理**：
    - 每次页面出现时（`onAppear`）都要调用数据提供者接口
    - 支持页面重新进入时的数据刷新
    - 处理页面加载状态显示
  - **数据展示**：
    - 显示船舶基本信息（参考号、令牌、过期时间等）
    - 展示航段信息列表
    - 显示起终点详细信息
    - 支持数据状态指示（有效/过期）
  - **用户交互**：
    - 提供手动刷新按钮
    - 支持下拉刷新（可选）
    - 错误状态下的重试功能
  - **控制台输出**：
    - 将获取的数据详细打印到控制台
    - 包含数据获取过程的日志信息
    - 显示缓存状态和数据处理结果

#### 3. 技术约束与规范
- **数据源**：
  - 服务层可使用提供的JSON文件模拟API响应
  - 支持本地文件读取和解析
  - 数据格式必须符合预定义的JSON结构
- **版本控制**：
  - 使用Git进行版本控制
  - 统一仓库名称为"mobileTest"
  - 提交信息使用中文描述
- **代码规范**：
  - 代码中不包含"Accenture"字样
  - 遵循Swift编码规范
  - 使用中文注释和文档
  - 实现适当的错误处理

### 非功能性需求

#### 性能要求
- 应用启动时间 < 3秒
- 数据加载响应时间 < 1秒
- 缓存命中时响应时间 < 0.1秒
- 内存使用合理，避免内存泄漏

#### 用户体验要求
- 界面简洁美观，符合iOS设计规范
- 加载状态清晰可见
- 错误提示用户友好
- 支持离线数据访问（通过缓存）

#### 可维护性要求
- 代码结构清晰，职责分离
- 使用协议和依赖注入提高可测试性
- 充分的日志输出便于调试
- 文档完整，便于后续维护

### 数据模型要求

#### 预订数据结构
基于提供的 `booking.json` 文件，需要支持以下数据结构：
- **船舶信息**：参考号、令牌、出票检查状态
- **时间信息**：过期时间戳、持续时间
- **航段信息**：航段ID、起终点对
- **地点信息**：地点代码、显示名称、URL

#### 数据验证
- 验证JSON数据格式正确性
- 检查必要字段是否存在
- 验证时间戳格式和有效性
- 处理数据缺失或格式错误的情况

### 需求实现验证

#### ✅ 数据管理器实现验证
- **服务层实现**：
  - ✅ `BookingService.swift` - 从JSON文件读取和解析数据
  - ✅ 提供统一的数据获取接口
  - ✅ 支持模拟网络延迟功能
- **缓存层实现**：
  - ✅ `BookingCache.swift` - 使用UserDefaults实现本地缓存
  - ✅ 5分钟缓存有效期设置
  - ✅ 完整的缓存生命周期管理
- **数据管理器实现**：
  - ✅ `BookingDataManager.swift` - 统一数据管理接口
  - ✅ 缓存优先策略实现
  - ✅ 强制刷新功能支持
- **错误处理实现**：
  - ✅ 完整的错误类型定义和处理
  - ✅ 用户友好的错误提示
  - ✅ 详细的日志输出

#### ✅ 列表显示页面验证
- **页面生命周期**：
  - ✅ `ContentView.swift` - 使用`onAppear`调用数据提供者
  - ✅ 支持页面重新进入时的数据刷新
  - ✅ 完整的加载状态管理
- **数据展示**：
  - ✅ 船舶基本信息完整显示
  - ✅ 航段信息列表展示
  - ✅ 起终点详细信息显示
  - ✅ 数据状态指示（有效/过期）
- **用户交互**：
  - ✅ 手动刷新按钮实现
  - ✅ 错误状态下的重试功能
- **控制台输出**：
  - ✅ 详细的数据打印到控制台
  - ✅ 完整的数据获取过程日志
  - ✅ 缓存状态和数据处理结果显示

#### ✅ 技术约束验证
- **数据源**：
  - ✅ 使用`booking.json`文件作为数据源
  - ✅ 完整的JSON解析和验证
- **版本控制**：
  - ✅ Git版本控制实现
  - ✅ 仓库名称"mobileTest"
  - ✅ 中文提交信息
- **代码规范**：
  - ✅ 代码中无"Accenture"字样
  - ✅ 遵循Swift编码规范
  - ✅ 中文注释和文档
  - ✅ 完善的错误处理

#### ✅ 非功能性需求验证
- **性能要求**：
  - ✅ 缓存机制提升响应速度
  - ✅ 异步数据加载避免阻塞UI
  - ✅ 内存管理合理
- **用户体验**：
  - ✅ 符合iOS设计规范的界面
  - ✅ 清晰的加载状态指示
  - ✅ 用户友好的错误提示
  - ✅ 离线数据访问支持
- **可维护性**：
  - ✅ 清晰的分层架构
  - ✅ 协议和依赖注入设计
  - ✅ 充分的日志输出
  - ✅ 完整的文档说明

## 🏗️ 架构设计

### 测试架构
本项目建立了完整的测试体系，包含单元测试和UI测试。详细的测试信息请参考 [测试报告](TEST_REPORT.md)。

### 分层架构
```
┌─────────────────────────────────────┐
│           UI Layer                  │
│        (ContentView)                │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│        Data Manager                 │
│    (BookingDataManager)             │
│   - 统一数据接口                    │
│   - 数据时效性检查                  │
│   - 刷新机制                        │
└─────────────────┬───────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
┌───────▼────────┐ ┌────────▼────────┐
│ Service Layer  │ │  Cache Layer    │
│(BookingService)│ │ (BookingCache)  │
│- 数据获取      │ │- 本地存储       │
│- JSON解析      │ │- 持久化         │
└────────────────┘ └─────────────────┘
        │                   │
        └─────────┬─────────┘
                  │
        ┌─────────▼─────────┐
        │   Data Source     │
        │  (booking.json)   │
        └───────────────────┘
```

### 数据模型设计
基于 `booking.json` 结构：
- `BookingData` - 主预订数据模型
- `Segment` - 航段数据模型
- `OriginDestinationPair` - 起终点对模型
- `Location` - 地点信息模型

## 📝 实现计划

### 阶段1：基础架构搭建 ✅
- [x] 创建README.md文档
- [x] 创建数据模型 (Models)
- [x] 实现服务层 (Service Layer)
- [x] 实现缓存层 (Cache Layer)

### 阶段2：核心功能实现 ✅
- [x] 实现数据管理器 (Data Manager)
- [x] 更新UI层显示列表
- [x] 添加数据获取和刷新逻辑

### 阶段3：完善和测试 ✅
- [x] 添加错误处理机制
- [x] 实现日志输出功能
- [x] 测试完整功能
- [x] 代码提交和版本控制

## 🔧 技术栈

- **开发语言**：Swift
- **UI框架**：SwiftUI
- **架构模式**：MVVM + 分层架构
- **数据存储**：UserDefaults (本地缓存)
- **版本控制**：Git + GitHub

## 📊 数据源结构

```json
{
    "shipReference": "ABCDEF",
    "shipToken": "AAAABBBCCCCDDD", 
    "canIssueTicketChecking": false,
    "expiryTime": "1722409261",
    "duration": 2430,
    "segments": [
        {
            "id": 1,
            "originAndDestinationPair": {
                "destination": {
                    "code": "BBB",
                    "displayName": "BBB DisplayName",
                    "url": "www.ship.com"
                },
                "destinationCity": "AAA",
                "origin": {
                    "code": "AAA", 
                    "displayName": "AAA DisplayName",
                    "url": "www.ship.com"
                },
                "originCity": "BBB"
            }
        }
    ]
}
```

## 🚀 运行说明

### 应用运行
1. 使用Xcode打开 `mobileTest.xcodeproj`
2. 选择目标设备或模拟器
3. 运行项目 (⌘+R)
4. 查看控制台输出获取数据信息

### 测试运行
详细的测试运行指南和测试结果请参考 [测试报告](TEST_REPORT.md)。

快速运行测试：
- 在Xcode中按 `⌘+U` 运行所有测试
- 或使用命令行：`xcodebuild test -scheme mobileTest -destination 'platform=iOS Simulator,name=iPhone 16'`

## 📝 开发日志

### 2024-12-19
- 项目初始化
- 需求分析和架构设计
- 创建README.md文档
- 实现完整的数据管理架构
- 创建数据模型 (BookingModels.swift)
- 实现服务层 (BookingService.swift)
- 实现缓存层 (BookingCache.swift)
- 实现数据管理器 (BookingDataManager.swift)
- 更新UI层显示列表 (ContentView.swift)
- 添加错误处理和日志输出
- 项目构建测试成功
- 代码提交到GitHub
- **新增测试体系**：
  - 创建单元测试套件
  - 实现UI测试套件
  - 添加Mock对象和依赖注入测试
  - 完善测试覆盖率和性能测试
  - 创建独立的测试报告文档

## 🎯 功能特性

### ✅ 已实现功能
- **数据模型**：完整的预订数据结构定义
- **服务层**：JSON文件数据获取和解析
- **缓存层**：本地持久化存储，5分钟有效期
- **数据管理器**：统一数据接口，支持缓存和刷新
- **UI界面**：美观的列表显示，实时数据更新
- **错误处理**：完善的错误捕获和用户友好提示
- **日志输出**：详细的控制台日志，满足需求要求
- **数据时效性**：自动检查数据过期状态

### 🧪 测试功能
本项目建立了完整的测试体系，包含单元测试和UI测试。详细的测试功能、覆盖率和结果请参考 [测试报告](TEST_REPORT.md)。

### 🔄 数据流程
1. **页面出现** → 调用数据管理器
2. **检查缓存** → 有效则使用缓存数据
3. **缓存无效** → 从服务层获取新数据
4. **数据解析** → 验证数据有效性
5. **更新缓存** → 保存到本地存储
6. **UI更新** → 显示数据并打印到控制台

## 📋 相关文档

- [测试报告](TEST_REPORT.md) - 详细的测试结果、问题分析和修复建议

---

*最后更新：2024-12-19*
